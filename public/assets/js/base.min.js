function hex_md5(t){return rstr2hex(rstr_md5(str2rstr_utf8(t)))}function hex_hmac_md5(t,e){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(t),str2rstr_utf8(e)))}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(t){return binl2rstr(binl_md5(rstr2binl(t),8*t.length))}function rstr_hmac_md5(t,e){var n=rstr2binl(t);n.length>16&&(n=binl_md5(n,8*t.length));for(var i=Array(16),r=Array(16),s=0;16>s;s++)i[s]=909522486^n[s],r[s]=1549556828^n[s];var a=binl_md5(i.concat(rstr2binl(e)),512+8*e.length);return binl2rstr(binl_md5(r.concat(a),640))}function rstr2hex(t){try{}catch(e){hexcase=0}for(var n=hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",r,s=0;s<t.length;s++)r=t.charCodeAt(s),i+=n.charAt(r>>>4&15)+n.charAt(15&r);return i}function str2rstr_utf8(t){for(var e="",n=-1,i,r;++n<t.length;)i=t.charCodeAt(n),r=n+1<t.length?t.charCodeAt(n+1):0,i>=55296&&56319>=i&&r>=56320&&57343>=r&&(i=65536+((1023&i)<<10)+(1023&r),n++),127>=i?e+=String.fromCharCode(i):2047>=i?e+=String.fromCharCode(192|i>>>6&31,128|63&i):65535>=i?e+=String.fromCharCode(224|i>>>12&15,128|i>>>6&63,128|63&i):2097151>=i&&(e+=String.fromCharCode(240|i>>>18&7,128|i>>>12&63,128|i>>>6&63,128|63&i));return e}function rstr2binl(t){for(var e=Array(t.length>>2),n=0;n<e.length;n++)e[n]=0;for(var n=0;n<8*t.length;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<n%32;return e}function binl2rstr(t){for(var e="",n=0;n<32*t.length;n+=8)e+=String.fromCharCode(t[n>>5]>>>n%32&255);return e}function binl_md5(t,e){t[e>>5]|=128<<e%32,t[(e+64>>>9<<4)+14]=e;for(var n=1732584193,i=-271733879,r=-1732584194,s=271733878,a=0;a<t.length;a+=16){var o=n,c=i,h=r,l=s;n=md5_ff(n,i,r,s,t[a+0],7,-680876936),s=md5_ff(s,n,i,r,t[a+1],12,-389564586),r=md5_ff(r,s,n,i,t[a+2],17,606105819),i=md5_ff(i,r,s,n,t[a+3],22,-1044525330),n=md5_ff(n,i,r,s,t[a+4],7,-176418897),s=md5_ff(s,n,i,r,t[a+5],12,1200080426),r=md5_ff(r,s,n,i,t[a+6],17,-1473231341),i=md5_ff(i,r,s,n,t[a+7],22,-45705983),n=md5_ff(n,i,r,s,t[a+8],7,1770035416),s=md5_ff(s,n,i,r,t[a+9],12,-1958414417),r=md5_ff(r,s,n,i,t[a+10],17,-42063),i=md5_ff(i,r,s,n,t[a+11],22,-1990404162),n=md5_ff(n,i,r,s,t[a+12],7,1804603682),s=md5_ff(s,n,i,r,t[a+13],12,-40341101),r=md5_ff(r,s,n,i,t[a+14],17,-1502002290),i=md5_ff(i,r,s,n,t[a+15],22,1236535329),n=md5_gg(n,i,r,s,t[a+1],5,-165796510),s=md5_gg(s,n,i,r,t[a+6],9,-1069501632),r=md5_gg(r,s,n,i,t[a+11],14,643717713),i=md5_gg(i,r,s,n,t[a+0],20,-373897302),n=md5_gg(n,i,r,s,t[a+5],5,-701558691),s=md5_gg(s,n,i,r,t[a+10],9,38016083),r=md5_gg(r,s,n,i,t[a+15],14,-660478335),i=md5_gg(i,r,s,n,t[a+4],20,-405537848),n=md5_gg(n,i,r,s,t[a+9],5,568446438),s=md5_gg(s,n,i,r,t[a+14],9,-1019803690),r=md5_gg(r,s,n,i,t[a+3],14,-187363961),i=md5_gg(i,r,s,n,t[a+8],20,1163531501),n=md5_gg(n,i,r,s,t[a+13],5,-1444681467),s=md5_gg(s,n,i,r,t[a+2],9,-51403784),r=md5_gg(r,s,n,i,t[a+7],14,1735328473),i=md5_gg(i,r,s,n,t[a+12],20,-1926607734),n=md5_hh(n,i,r,s,t[a+5],4,-378558),s=md5_hh(s,n,i,r,t[a+8],11,-2022574463),r=md5_hh(r,s,n,i,t[a+11],16,1839030562),i=md5_hh(i,r,s,n,t[a+14],23,-35309556),n=md5_hh(n,i,r,s,t[a+1],4,-1530992060),s=md5_hh(s,n,i,r,t[a+4],11,1272893353),r=md5_hh(r,s,n,i,t[a+7],16,-155497632),i=md5_hh(i,r,s,n,t[a+10],23,-1094730640),n=md5_hh(n,i,r,s,t[a+13],4,681279174),s=md5_hh(s,n,i,r,t[a+0],11,-358537222),r=md5_hh(r,s,n,i,t[a+3],16,-722521979),i=md5_hh(i,r,s,n,t[a+6],23,76029189),n=md5_hh(n,i,r,s,t[a+9],4,-640364487),s=md5_hh(s,n,i,r,t[a+12],11,-421815835),r=md5_hh(r,s,n,i,t[a+15],16,530742520),i=md5_hh(i,r,s,n,t[a+2],23,-995338651),n=md5_ii(n,i,r,s,t[a+0],6,-198630844),s=md5_ii(s,n,i,r,t[a+7],10,1126891415),r=md5_ii(r,s,n,i,t[a+14],15,-1416354905),i=md5_ii(i,r,s,n,t[a+5],21,-57434055),n=md5_ii(n,i,r,s,t[a+12],6,1700485571),s=md5_ii(s,n,i,r,t[a+3],10,-1894986606),r=md5_ii(r,s,n,i,t[a+10],15,-1051523),i=md5_ii(i,r,s,n,t[a+1],21,-2054922799),n=md5_ii(n,i,r,s,t[a+8],6,1873313359),s=md5_ii(s,n,i,r,t[a+15],10,-30611744),r=md5_ii(r,s,n,i,t[a+6],15,-1560198380),i=md5_ii(i,r,s,n,t[a+13],21,1309151649),n=md5_ii(n,i,r,s,t[a+4],6,-145523070),s=md5_ii(s,n,i,r,t[a+11],10,-1120210379),r=md5_ii(r,s,n,i,t[a+2],15,718787259),i=md5_ii(i,r,s,n,t[a+9],21,-343485551),n=safe_add(n,o),i=safe_add(i,c),r=safe_add(r,h),s=safe_add(s,l)}return Array(n,i,r,s)}function md5_cmn(t,e,n,i,r,s){return safe_add(bit_rol(safe_add(safe_add(e,t),safe_add(i,s)),r),n)}function md5_ff(t,e,n,i,r,s,a){return md5_cmn(e&n|~e&i,t,e,r,s,a)}function md5_gg(t,e,n,i,r,s,a){return md5_cmn(e&i|n&~i,t,e,r,s,a)}function md5_hh(t,e,n,i,r,s,a){return md5_cmn(e^n^i,t,e,r,s,a)}function md5_ii(t,e,n,i,r,s,a){return md5_cmn(n^(e|~i),t,e,r,s,a)}function safe_add(t,e){var n=(65535&t)+(65535&e),i=(t>>16)+(e>>16)+(n>>16);return i<<16|65535&n}function bit_rol(t,e){return t<<e|t>>>32-e}function User(){}function Cryptography(){}function Chat(){}function Page(){}function Template(){}function Route(){}function showHomepage(){var t={submitForm:function(t){t.preventDefault(),chat.user.set("passphrase",$("#homepage form #passphrase").val()),chat.user.set("name",chat.cryptography.encrypt($("#homepage form #name").val())),chat.user.set("email",chat.cryptography.encrypt($("#homepage form #email").val())),chat.chat.login(),chat.route.setHash("chat/"+chat.user.get("passphrase"))}},e=chat.template.build("homepage.ejs",{passphrase:chat.user.get("passphrase")},t);$("#chat").empty().append(e)}function showChat(){var t={submitForm:function(t){t.preventDefault();var e=$("#conversation form input");""!=e.val()&&(chat.chat.send(e.val()),e.val(""))}},e=chat.template.build("chat.ejs",{},t);$("#chat").empty().append(e),$("#conversation form input").focus();var n=0,i=new Audio("/assets/audio/notification.wav");i.load(),chat.page.setVisibilityChangeCallback(function(){chat.page.isActive()&&(n=0,document.title="Chatting")}),chat.chat.listen(function(t){switch(t.type){case"users":for(var e in t.users)$("#conversation #users").append('<li data-key="'+t.users[e].key+'"><img alt="'+t.users[e].name+'" src="//www.gravatar.com/avatar/'+hex_md5(t.users[e].email)+'" />'+t.users[e].name+"</li>");break;case"login":0==$("#conversation #users li[data-key="+t.user.key+"]").length&&$("#conversation #users").append('<li data-key="'+t.user.key+'"><img alt="'+t.user.name+'" src="//www.gravatar.com/avatar/'+hex_md5(t.user.email)+'" />'+t.user.name+"</li>");break;case"message":var r=new Date(t.sent);t.sent=(r.getHours()<10?"0":"")+r.getHours()+":"+(r.getMinutes()<10?"0":"")+r.getMinutes(),$("#conversation #messages").append(chat.template.build("chat-message.ejs",t)),chat.page.isActive()||(n++,1==n&&i.play(),document.title="("+n+") Chatting");break;case"logout":$("#conversation #users li[data-key="+t.user.key+"]").remove()}document.querySelector("#conversation #messages").scrollTop=99999}),chat.chat.setDisconnectCallback(function(){$("#conversation #users").html("")})}var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(t){this.toString=function(){return"CORRUPT: "+this.message},this.message=t},invalid:function(t){this.toString=function(){return"INVALID: "+this.message},this.message=t},bug:function(t){this.toString=function(){return"BUG: "+this.message},this.message=t},notReady:function(t){this.toString=function(){return"NOT READY: "+this.message},this.message=t}}};"undefined"!=typeof module&&module.exports&&(module.exports=sjcl),sjcl.cipher.aes=function(t){this.h[0][0][0]||this.z();var e,n,i,r,s=this.h[0][4],a=this.h[1];e=t.length;var o=1;if(4!==e&&6!==e&&8!==e)throw new sjcl.exception.invalid("invalid aes key size");for(this.a=[i=t.slice(0),r=[]],t=e;4*e+28>t;t++)n=i[t-1],(t%e===0||8===e&&t%e===4)&&(n=s[n>>>24]<<24^s[n>>16&255]<<16^s[n>>8&255]<<8^s[255&n],t%e===0&&(n=n<<8^n>>>24^o<<24,o=o<<1^283*(o>>7))),i[t]=i[t-e]^n;for(e=0;t;e++,t--)n=i[3&e?t:t-4],r[e]=4>=t||4>e?n:a[0][s[n>>>24]]^a[1][s[n>>16&255]]^a[2][s[n>>8&255]]^a[3][s[255&n]]},sjcl.cipher.aes.prototype={encrypt:function(t){return this.I(t,0)},decrypt:function(t){return this.I(t,1)},h:[[[],[],[],[],[]],[[],[],[],[],[]]],z:function(){var t=this.h[0],e=this.h[1],n=t[4],i=e[4],r,s,a,o=[],c=[],h,l,u,f;for(r=0;256>r;r++)c[(o[r]=r<<1^283*(r>>7))^r]=r;for(s=a=0;!n[s];s^=h||1,a=c[a]||1)for(u=a^a<<1^a<<2^a<<3^a<<4,u=u>>8^255&u^99,n[s]=u,i[u]=s,l=o[r=o[h=o[s]]],f=16843009*l^65537*r^257*h^16843008*s,l=257*o[u]^16843008*u,r=0;4>r;r++)t[r][s]=l=l<<24^l>>>8,e[r][u]=f=f<<24^f>>>8;for(r=0;5>r;r++)t[r]=t[r].slice(0),e[r]=e[r].slice(0)},I:function(t,e){if(4!==t.length)throw new sjcl.exception.invalid("invalid aes block size");var n=this.a[e],i=t[0]^n[0],r=t[e?3:1]^n[1],s=t[2]^n[2];t=t[e?1:3]^n[3];var a,o,c,h=n.length/4-2,l,u=4,f=[0,0,0,0];a=this.h[e];var p=a[0],d=a[1],m=a[2],g=a[3],y=a[4];for(l=0;h>l;l++)a=p[i>>>24]^d[r>>16&255]^m[s>>8&255]^g[255&t]^n[u],o=p[r>>>24]^d[s>>16&255]^m[t>>8&255]^g[255&i]^n[u+1],c=p[s>>>24]^d[t>>16&255]^m[i>>8&255]^g[255&r]^n[u+2],t=p[t>>>24]^d[i>>16&255]^m[r>>8&255]^g[255&s]^n[u+3],u+=4,i=a,r=o,s=c;for(l=0;4>l;l++)f[e?3&-l:l]=y[i>>>24]<<24^y[r>>16&255]<<16^y[s>>8&255]<<8^y[255&t]^n[u++],a=i,i=r,r=s,s=t,t=a;return f}},sjcl.bitArray={bitSlice:function(t,e,n){return t=sjcl.bitArray.P(t.slice(e/32),32-(31&e)).slice(1),void 0===n?t:sjcl.bitArray.clamp(t,n-e)},extract:function(t,e,n){var i=Math.floor(-e-n&31);return(-32&(e+n-1^e)?t[e/32|0]<<32-i^t[e/32+1|0]>>>i:t[e/32|0]>>>i)&(1<<n)-1},concat:function(t,e){if(0===t.length||0===e.length)return t.concat(e);var n=t[t.length-1],i=sjcl.bitArray.getPartial(n);return 32===i?t.concat(e):sjcl.bitArray.P(e,i,0|n,t.slice(0,t.length-1))},bitLength:function(t){var e=t.length;return 0===e?0:32*(e-1)+sjcl.bitArray.getPartial(t[e-1])},clamp:function(t,e){if(32*t.length<e)return t;t=t.slice(0,Math.ceil(e/32));var n=t.length;return e&=31,n>0&&e&&(t[n-1]=sjcl.bitArray.partial(e,t[n-1]&2147483648>>e-1,1)),t},partial:function(t,e,n){return 32===t?e:(n?0|e:e<<32-t)+1099511627776*t},getPartial:function(t){return Math.round(t/1099511627776)||32},equal:function(t,e){if(sjcl.bitArray.bitLength(t)!==sjcl.bitArray.bitLength(e))return!1;var n=0,i;for(i=0;i<t.length;i++)n|=t[i]^e[i];return 0===n},P:function(t,e,n,i){var r;for(r=0,void 0===i&&(i=[]);e>=32;e-=32)i.push(n),n=0;if(0===e)return i.concat(t);for(r=0;r<t.length;r++)i.push(n|t[r]>>>e),n=t[r]<<32-e;return r=t.length?t[t.length-1]:0,t=sjcl.bitArray.getPartial(r),i.push(sjcl.bitArray.partial(e+t&31,e+t>32?n:i.pop(),1)),i},k:function(t,e){return[t[0]^e[0],t[1]^e[1],t[2]^e[2],t[3]^e[3]]}},sjcl.codec.utf8String={fromBits:function(t){var e="",n=sjcl.bitArray.bitLength(t),i,r;for(i=0;n/8>i;i++)0===(3&i)&&(r=t[i/4]),e+=String.fromCharCode(r>>>24),r<<=8;return decodeURIComponent(escape(e))},toBits:function(t){t=unescape(encodeURIComponent(t));var e=[],n,i=0;for(n=0;n<t.length;n++)i=i<<8|t.charCodeAt(n),3===(3&n)&&(e.push(i),i=0);return 3&n&&e.push(sjcl.bitArray.partial(8*(3&n),i)),e}},sjcl.codec.hex={fromBits:function(t){var e="",n;for(n=0;n<t.length;n++)e+=((0|t[n])+0xf00000000000).toString(16).substr(4);return e.substr(0,sjcl.bitArray.bitLength(t)/4)},toBits:function(t){var e,n=[],i;for(t=t.replace(/\s|0x/g,""),i=t.length,t+="00000000",e=0;e<t.length;e+=8)n.push(0^parseInt(t.substr(e,8),16));return sjcl.bitArray.clamp(n,4*i)}},sjcl.codec.base64={F:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(t,e,n){var i="",r=0,s=sjcl.codec.base64.F,a=0,o=sjcl.bitArray.bitLength(t);for(n&&(s=s.substr(0,62)+"-_"),n=0;6*i.length<o;)i+=s.charAt((a^t[n]>>>r)>>>26),6>r?(a=t[n]<<6-r,r+=26,n++):(a<<=6,r-=6);for(;3&i.length&&!e;)i+="=";return i},toBits:function(t,e){t=t.replace(/\s|=/g,"");var n=[],i=0,r=sjcl.codec.base64.F,s=0,a;for(e&&(r=r.substr(0,62)+"-_"),e=0;e<t.length;e++){if(a=r.indexOf(t.charAt(e)),0>a)throw new sjcl.exception.invalid("this isn't base64!");i>26?(i-=26,n.push(s^a>>>i),s=a<<32-i):(i+=6,s^=a<<32-i)}return 56&i&&n.push(sjcl.bitArray.partial(56&i,s,1)),n}},sjcl.codec.base64url={fromBits:function(t){return sjcl.codec.base64.fromBits(t,1,1)},toBits:function(t){return sjcl.codec.base64.toBits(t,1)}},sjcl.hash.sha256=function(t){this.a[0]||this.z(),t?(this.n=t.n.slice(0),this.i=t.i.slice(0),this.e=t.e):this.reset()},sjcl.hash.sha256.hash=function(t){return(new sjcl.hash.sha256).update(t).finalize()},sjcl.hash.sha256.prototype={blockSize:512,reset:function(){return this.n=this.N.slice(0),this.i=[],this.e=0,this},update:function(t){"string"==typeof t&&(t=sjcl.codec.utf8String.toBits(t));var e,n=this.i=sjcl.bitArray.concat(this.i,t);for(e=this.e,t=this.e=e+sjcl.bitArray.bitLength(t),e=512+e&-512;t>=e;e+=512)this.D(n.splice(0,16));return this},finalize:function(){var t,e=this.i,n=this.n;for(e=sjcl.bitArray.concat(e,[sjcl.bitArray.partial(1,1)]),t=e.length+2;15&t;t++)e.push(0);for(e.push(Math.floor(this.e/4294967296)),e.push(0|this.e);e.length;)this.D(e.splice(0,16));return this.reset(),n},N:[],a:[],z:function(){function t(t){return 4294967296*(t-Math.floor(t))|0}var e=0,n=2,i;t:for(;64>e;n++){for(i=2;n>=i*i;i++)if(n%i===0)continue t;8>e&&(this.N[e]=t(Math.pow(n,.5))),this.a[e]=t(Math.pow(n,1/3)),e++}},D:function(t){var e,n,i=t.slice(0),r=this.n,s=this.a,a=r[0],o=r[1],c=r[2],h=r[3],l=r[4],u=r[5],f=r[6],p=r[7];for(t=0;64>t;t++)16>t?e=i[t]:(e=i[t+1&15],n=i[t+14&15],e=i[15&t]=(e>>>7^e>>>18^e>>>3^e<<25^e<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+i[15&t]+i[t+9&15]|0),e=e+p+(l>>>6^l>>>11^l>>>25^l<<26^l<<21^l<<7)+(f^l&(u^f))+s[t],p=f,f=u,u=l,l=h+e|0,h=c,c=o,o=a,a=e+(o&c^h&(o^c))+(o>>>2^o>>>13^o>>>22^o<<30^o<<19^o<<10)|0;r[0]=r[0]+a|0,r[1]=r[1]+o|0,r[2]=r[2]+c|0,r[3]=r[3]+h|0,r[4]=r[4]+l|0,r[5]=r[5]+u|0,r[6]=r[6]+f|0,r[7]=r[7]+p|0}},sjcl.mode.ccm={name:"ccm",encrypt:function(t,e,n,i,r){var s,a=e.slice(0),o=sjcl.bitArray,c=o.bitLength(n)/8,h=o.bitLength(a)/8;if(r=r||64,i=i||[],7>c)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(s=2;4>s&&h>>>8*s;s++);return 15-c>s&&(s=15-c),n=o.clamp(n,8*(15-s)),e=sjcl.mode.ccm.H(t,e,n,i,r,s),a=sjcl.mode.ccm.J(t,a,n,e,r,s),o.concat(a.data,a.tag)},decrypt:function(t,e,n,i,r){r=r||64,i=i||[];var s=sjcl.bitArray,a=s.bitLength(n)/8,o=s.bitLength(e),c=s.clamp(e,o-r),h=s.bitSlice(e,o-r);if(o=(o-r)/8,7>a)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(e=2;4>e&&o>>>8*e;e++);if(15-a>e&&(e=15-a),n=s.clamp(n,8*(15-e)),c=sjcl.mode.ccm.J(t,c,n,h,r,e),t=sjcl.mode.ccm.H(t,c.data,n,i,r,e),!s.equal(c.tag,t))throw new sjcl.exception.corrupt("ccm: tag doesn't match");return c.data},H:function(t,e,n,i,r,s){var a=[],o=sjcl.bitArray,c=o.k;if(r/=8,r%2||4>r||r>16)throw new sjcl.exception.invalid("ccm: invalid tag length");if(i.length>4294967295||e.length>4294967295)throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data");if(s=[o.partial(8,(i.length?64:0)|r-2<<2|s-1)],s=o.concat(s,n),s[3]|=o.bitLength(e)/8,s=t.encrypt(s),i.length)for(n=o.bitLength(i)/8,65279>=n?a=[o.partial(16,n)]:4294967295>=n&&(a=o.concat([o.partial(16,65534)],[n])),a=o.concat(a,i),i=0;i<a.length;i+=4)s=t.encrypt(c(s,a.slice(i,i+4).concat([0,0,0])));for(i=0;i<e.length;i+=4)s=t.encrypt(c(s,e.slice(i,i+4).concat([0,0,0])));return o.clamp(s,8*r)},J:function(t,e,n,i,r,s){var a,o=sjcl.bitArray;a=o.k;var c=e.length,h=o.bitLength(e);if(n=o.concat([o.partial(8,s-1)],n).concat([0,0,0]).slice(0,4),i=o.bitSlice(a(i,t.encrypt(n)),0,r),!c)return{tag:i,data:[]};for(a=0;c>a;a+=4)n[3]++,r=t.encrypt(n),e[a]^=r[0],e[a+1]^=r[1],e[a+2]^=r[2],e[a+3]^=r[3];return{tag:i,data:o.clamp(e,h)}}},sjcl.mode.ocb2={name:"ocb2",encrypt:function(t,e,n,i,r,s){if(128!==sjcl.bitArray.bitLength(n))throw new sjcl.exception.invalid("ocb iv must be 128 bits");var a,o=sjcl.mode.ocb2.B,c=sjcl.bitArray,h=c.k,l=[0,0,0,0];n=o(t.encrypt(n));var u,f=[];for(i=i||[],r=r||64,a=0;a+4<e.length;a+=4)u=e.slice(a,a+4),l=h(l,u),f=f.concat(h(n,t.encrypt(h(n,u)))),n=o(n);return u=e.slice(a),e=c.bitLength(u),a=t.encrypt(h(n,[0,0,0,e])),u=c.clamp(h(u.concat([0,0,0]),a),e),l=h(l,h(u.concat([0,0,0]),a)),l=t.encrypt(h(l,h(n,o(n)))),i.length&&(l=h(l,s?i:sjcl.mode.ocb2.pmac(t,i))),f.concat(c.concat(u,c.clamp(l,r)))},decrypt:function(t,e,n,i,r,s){if(128!==sjcl.bitArray.bitLength(n))throw new sjcl.exception.invalid("ocb iv must be 128 bits");r=r||64;var a=sjcl.mode.ocb2.B,o=sjcl.bitArray,c=o.k,h=[0,0,0,0],l=a(t.encrypt(n)),u,f,p=sjcl.bitArray.bitLength(e)-r,d=[];for(i=i||[],n=0;p/32>n+4;n+=4)u=c(l,t.decrypt(c(l,e.slice(n,n+4)))),h=c(h,u),d=d.concat(u),l=a(l);if(f=p-32*n,u=t.encrypt(c(l,[0,0,0,f])),u=c(u,o.clamp(e.slice(n),f).concat([0,0,0])),h=c(h,u),h=t.encrypt(c(h,c(l,a(l)))),i.length&&(h=c(h,s?i:sjcl.mode.ocb2.pmac(t,i))),!o.equal(o.clamp(h,r),o.bitSlice(e,p)))throw new sjcl.exception.corrupt("ocb: tag doesn't match");return d.concat(o.clamp(u,f))},pmac:function(t,e){var n,i=sjcl.mode.ocb2.B,r=sjcl.bitArray,s=r.k,a=[0,0,0,0],o=t.encrypt([0,0,0,0]);for(o=s(o,i(i(o))),n=0;n+4<e.length;n+=4)o=i(o),a=s(a,t.encrypt(s(o,e.slice(n,n+4))));return e=e.slice(n),r.bitLength(e)<128&&(o=s(o,i(o)),e=r.concat(e,[-2147483648,0,0,0])),a=s(a,e),t.encrypt(s(i(s(o,i(o))),a))},B:function(t){return[t[0]<<1^t[1]>>>31,t[1]<<1^t[2]>>>31,t[2]<<1^t[3]>>>31,t[3]<<1^135*(t[0]>>>31)]}},sjcl.misc.hmac=function(t,e){this.M=e=e||sjcl.hash.sha256;var n=[[],[]],i=e.prototype.blockSize/32;for(this.l=[new e,new e],t.length>i&&(t=e.hash(t)),e=0;i>e;e++)n[0][e]=909522486^t[e],n[1][e]=1549556828^t[e];this.l[0].update(n[0]),this.l[1].update(n[1])},sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(t,e){return t=new this.M(this.l[0]).update(t,e).finalize(),new this.M(this.l[1]).update(t).finalize()},sjcl.misc.pbkdf2=function(t,e,n,i,r){if(n=n||1e3,0>i||0>n)throw sjcl.exception.invalid("invalid params to pbkdf2");"string"==typeof t&&(t=sjcl.codec.utf8String.toBits(t)),r=r||sjcl.misc.hmac,t=new r(t);var s,a,o,c,h=[],l=sjcl.bitArray;for(c=1;32*h.length<(i||1);c++){for(r=s=t.encrypt(l.concat(e,[c])),a=1;n>a;a++)for(s=t.encrypt(s),o=0;o<s.length;o++)r[o]^=s[o];h=h.concat(r)}return i&&(h=l.clamp(h,i)),h},sjcl.random={randomWords:function(t,e){var n=[];e=this.isReady(e);var i;if(0===e)throw new sjcl.exception.notReady("generator isn't seeded");for(2&e&&this.U(!(1&e)),e=0;t>e;e+=4)(e+1)%65536===0&&this.L(),i=this.w(),n.push(i[0],i[1],i[2],i[3]);return this.L(),n.slice(0,t)},setDefaultParanoia:function(t){this.t=t},addEntropy:function(t,e,n){n=n||"user";var i,r,s=(new Date).valueOf(),a=this.q[n],o=this.isReady(),c=0;switch(i=this.G[n],void 0===i&&(i=this.G[n]=this.R++),void 0===a&&(a=this.q[n]=0),this.q[n]=(this.q[n]+1)%this.b.length,typeof t){case"number":void 0===e&&(e=1),this.b[a].update([i,this.u++,1,e,s,1,0|t]);break;case"object":if(n=Object.prototype.toString.call(t),"[object Uint32Array]"===n){for(r=[],n=0;n<t.length;n++)r.push(t[n]);t=r}else for("[object Array]"!==n&&(c=1),n=0;n<t.length&&!c;n++)"number"!=typeof t[n]&&(c=1);if(!c){if(void 0===e)for(n=e=0;n<t.length;n++)for(r=t[n];r>0;)e++,r>>>=1;this.b[a].update([i,this.u++,2,e,s,t.length].concat(t))}break;case"string":void 0===e&&(e=t.length),this.b[a].update([i,this.u++,3,e,s,t.length]),this.b[a].update(t);break;default:c=1}if(c)throw new sjcl.exception.bug("random: addEntropy only supports number, array of numbers or string");this.j[a]+=e,this.f+=e,0===o&&(0!==this.isReady()&&this.K("seeded",Math.max(this.g,this.f)),this.K("progress",this.getProgress()))},isReady:function(t){return t=this.C[void 0!==t?t:this.t],this.g&&this.g>=t?this.j[0]>80&&(new Date).valueOf()>this.O?3:1:this.f>=t?2:0},getProgress:function(t){return t=this.C[t?t:this.t],this.g>=t?1:this.f>t?1:this.f/t},startCollectors:function(){if(!this.m){if(window.addEventListener)window.addEventListener("load",this.o,!1),window.addEventListener("mousemove",this.p,!1);else{if(!document.attachEvent)throw new sjcl.exception.bug("can't attach event");document.attachEvent("onload",this.o),document.attachEvent("onmousemove",this.p)}this.m=!0}},stopCollectors:function(){this.m&&(window.removeEventListener?(window.removeEventListener("load",this.o,!1),window.removeEventListener("mousemove",this.p,!1)):window.detachEvent&&(window.detachEvent("onload",this.o),window.detachEvent("onmousemove",this.p)),this.m=!1)},addEventListener:function(t,e){this.r[t][this.Q++]=e},removeEventListener:function(t,e){var n;t=this.r[t];var i=[];for(n in t)t.hasOwnProperty(n)&&t[n]===e&&i.push(n);for(e=0;e<i.length;e++)n=i[e],delete t[n]},b:[new sjcl.hash.sha256],j:[0],A:0,q:{},u:0,G:{},R:0,g:0,f:0,O:0,a:[0,0,0,0,0,0,0,0],d:[0,0,0,0],s:void 0,t:6,m:!1,r:{progress:{},seeded:{}},Q:0,C:[0,48,64,96,128,192,256,384,512,768,1024],w:function(){for(var t=0;4>t&&(this.d[t]=this.d[t]+1|0,!this.d[t]);t++);return this.s.encrypt(this.d)},L:function(){this.a=this.w().concat(this.w()),this.s=new sjcl.cipher.aes(this.a)},T:function(t){for(this.a=sjcl.hash.sha256.hash(this.a.concat(t)),this.s=new sjcl.cipher.aes(this.a),t=0;4>t&&(this.d[t]=this.d[t]+1|0,!this.d[t]);t++);},U:function(t){var e=[],n=0,i;for(this.O=e[0]=(new Date).valueOf()+3e4,i=0;16>i;i++)e.push(4294967296*Math.random()|0);for(i=0;i<this.b.length&&(e=e.concat(this.b[i].finalize()),n+=this.j[i],this.j[i]=0,t||!(this.A&1<<i));i++);this.A>=1<<this.b.length&&(this.b.push(new sjcl.hash.sha256),this.j.push(0)),this.f-=n,n>this.g&&(this.g=n),this.A++,this.T(e)},p:function(t){sjcl.random.addEntropy([t.x||t.clientX||t.offsetX||0,t.y||t.clientY||t.offsetY||0],2,"mouse")},o:function(){sjcl.random.addEntropy((new Date).valueOf(),2,"loadtime")},K:function(t,e){var n;t=sjcl.random.r[t];var i=[];for(n in t)t.hasOwnProperty(n)&&i.push(t[n]);for(n=0;n<i.length;n++)i[n](e)}};try{var s=new Uint32Array(32);crypto.getRandomValues(s),sjcl.random.addEntropy(s,1024,"crypto['getRandomValues']")}catch(t){}sjcl.json={defaults:{v:1,iter:1e3,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},encrypt:function(t,e,n,i){n=n||{},i=i||{};var r=sjcl.json,s=r.c({iv:sjcl.random.randomWords(4,0)},r.defaults),a;if(r.c(s,n),n=s.adata,"string"==typeof s.salt&&(s.salt=sjcl.codec.base64.toBits(s.salt)),"string"==typeof s.iv&&(s.iv=sjcl.codec.base64.toBits(s.iv)),!sjcl.mode[s.mode]||!sjcl.cipher[s.cipher]||"string"==typeof t&&s.iter<=100||64!==s.ts&&96!==s.ts&&128!==s.ts||128!==s.ks&&192!==s.ks&&256!==s.ks||s.iv.length<2||s.iv.length>4)throw new sjcl.exception.invalid("json encrypt: invalid parameters");return"string"==typeof t&&(a=sjcl.misc.cachedPbkdf2(t,s),t=a.key.slice(0,s.ks/32),s.salt=a.salt),"string"==typeof e&&(e=sjcl.codec.utf8String.toBits(e)),"string"==typeof n&&(n=sjcl.codec.utf8String.toBits(n)),a=new sjcl.cipher[s.cipher](t),r.c(i,s),i.key=t,s.ct=sjcl.mode[s.mode].encrypt(a,e,s.iv,n,s.ts),r.encode(s)},decrypt:function(t,e,n,i){n=n||{},i=i||{};var r=sjcl.json;e=r.c(r.c(r.c({},r.defaults),r.decode(e)),n,!0);var s;if(n=e.adata,"string"==typeof e.salt&&(e.salt=sjcl.codec.base64.toBits(e.salt)),"string"==typeof e.iv&&(e.iv=sjcl.codec.base64.toBits(e.iv)),!sjcl.mode[e.mode]||!sjcl.cipher[e.cipher]||"string"==typeof t&&e.iter<=100||64!==e.ts&&96!==e.ts&&128!==e.ts||128!==e.ks&&192!==e.ks&&256!==e.ks||!e.iv||e.iv.length<2||e.iv.length>4)throw new sjcl.exception.invalid("json decrypt: invalid parameters");return"string"==typeof t&&(s=sjcl.misc.cachedPbkdf2(t,e),t=s.key.slice(0,e.ks/32),e.salt=s.salt),"string"==typeof n&&(n=sjcl.codec.utf8String.toBits(n)),s=new sjcl.cipher[e.cipher](t),n=sjcl.mode[e.mode].decrypt(s,e.ct,e.iv,n,e.ts),r.c(i,e),i.key=t,sjcl.codec.utf8String.fromBits(n)},encode:function(t){var e,n="{",i="";for(e in t)if(t.hasOwnProperty(e)){if(!e.match(/^[a-z0-9]+$/i))throw new sjcl.exception.invalid("json encode: invalid property name");switch(n+=i+'"'+e+'":',i=",",typeof t[e]){case"number":case"boolean":n+=t[e];break;case"string":n+='"'+escape(t[e])+'"';break;case"object":n+='"'+sjcl.codec.base64.fromBits(t[e],1)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type")}}return n+"}"},decode:function(t){if(t=t.replace(/\s/g,""),!t.match(/^\{.*\}$/))throw new sjcl.exception.invalid("json decode: this isn't json!");t=t.replace(/^\{|\}$/g,"").split(/,/);var e={},n,i;for(n=0;n<t.length;n++){if(!(i=t[n].match(/^(?:(["']?)([a-z][a-z0-9]*)\1):(?:(\d+)|"([a-z0-9+\/%*_.@=\-]*)")$/i)))throw new sjcl.exception.invalid("json decode: this isn't json!");e[i[2]]=i[3]?parseInt(i[3],10):i[2].match(/^(ct|salt|iv)$/)?sjcl.codec.base64.toBits(i[4]):unescape(i[4])}return e},c:function(t,e,n){if(void 0===t&&(t={}),void 0===e)return t;var i;for(i in e)if(e.hasOwnProperty(i)){if(n&&void 0!==t[i]&&t[i]!==e[i])throw new sjcl.exception.invalid("required parameter overridden");t[i]=e[i]}return t},W:function(t,e){var n={},i;for(i in t)t.hasOwnProperty(i)&&t[i]!==e[i]&&(n[i]=t[i]);return n},V:function(t,e){var n={},i;for(i=0;i<e.length;i++)void 0!==t[e[i]]&&(n[e[i]]=t[e[i]]);return n}},sjcl.encrypt=sjcl.json.encrypt,sjcl.decrypt=sjcl.json.decrypt,sjcl.misc.S={},sjcl.misc.cachedPbkdf2=function(t,e){var n=sjcl.misc.S,i;return e=e||{},i=e.iter||1e3,n=n[t]=n[t]||{},i=n[i]=n[i]||{firstSalt:e.salt&&e.salt.length?e.salt.slice(0):sjcl.random.randomWords(2,0)},n=void 0===e.salt?i.firstSalt:e.salt,i[n]=i[n]||sjcl.misc.pbkdf2(t,n,e.iter),{key:i[n].slice(0),salt:n.slice(0)}};var hexcase=0;!function(){var rsplit=function(t,e){for(var n=e.exec(t),i=new Array,r,s,a;null!=n;)r=n.index,s=e.lastIndex,0!=r&&(a=t.substring(0,r),i.push(t.substring(0,r)),t=t.slice(r)),i.push(n[0]),t=t.slice(n[0].length),n=e.exec(t);return""==!t&&i.push(t),i},chop=function(t){return t.substr(0,t.length-1)},extend=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};EJS=function(t){if(t="string"==typeof t?{view:t}:t,this.set_options(t),t.precompiled)return this.template={},this.template.process=t.precompiled,void EJS.update(this.name,this);if(t.element){if("string"==typeof t.element){var e=t.element;if(t.element=document.getElementById(t.element),null==t.element)throw e+"does not exist!"}this.text=t.element.value?t.element.value:t.element.innerHTML,this.name=t.element.id,this.type="["}else if(t.url){t.url=EJS.endExt(t.url,this.extMatch),this.name=this.name?this.name:t.url;var n=t.url,i=EJS.get(this.name,this.cache);if(i)return i;if(i==EJS.INVALID_PATH)return null;try{this.text=EJS.request(n+(this.cache?"":"?"+Math.random()))}catch(r){}if(null==this.text)throw{type:"EJS",message:"There is no template at "+n}}var i=new EJS.Compiler(this.text,this.type);i.compile(t,this.name),EJS.update(this.name,this),this.template=i},EJS.prototype={render:function(t,e){t=t||{},this._extra_helpers=e;var n=new EJS.Helpers(t,e||{});return this.template.process.call(t,t,n)},update:function(element,options){return"string"==typeof element&&(element=document.getElementById(element)),null==options?(_template=this,function(t){EJS.prototype.update.call(_template,element,t)}):void("string"==typeof options?(params={},params.url=options,_template=this,params.onComplete=function(request){var object=eval(request.responseText);EJS.prototype.update.call(_template,element,object)},EJS.ajax_request(params)):element.innerHTML=this.render(options))},out:function(){return this.template.out},set_options:function(t){this.type=t.type||EJS.type,this.cache=null!=t.cache?t.cache:EJS.cache,this.text=t.text||null,this.name=t.name||null,this.ext=t.ext||EJS.ext,this.extMatch=new RegExp(this.ext.replace(/\./,"."))}},EJS.endExt=function(t,e){return t?(e.lastIndex=0,t+(e.test(t)?"":this.ext)):null},EJS.Scanner=function(t,e,n){extend(this,{left_delimiter:e+"%",right_delimiter:"%"+n,double_left:e+"%%",double_right:"%%"+n,left_equal:e+"%=",left_comment:e+"%#"}),this.SplitRegexp="["==e?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)"),this.source=t,this.stag=null,this.lines=0},EJS.Scanner.to_text=function(t){return null==t||void 0===t?"":t instanceof Date?t.toDateString():t.toString?t.toString():""},EJS.Scanner.prototype={scan:function(t){if(scanline=this.scanline,regex=this.SplitRegexp,""==!this.source)for(var e=rsplit(this.source,/\n/),n=0;n<e.length;n++){var i=e[n];this.scanline(i,regex,t)}},scanline:function(t,e,n){this.lines++;for(var i=rsplit(t,e),r=0;r<i.length;r++){var s=i[r];if(null!=s)try{n(s,this)}catch(a){throw{type:"EJS.Scanner",line:this.lines}}}}},EJS.Buffer=function(t,e){this.line=new Array,this.script="",this.pre_cmd=t,this.post_cmd=e;for(var n=0;n<this.pre_cmd.length;n++)this.push(t[n])},EJS.Buffer.prototype={push:function(t){this.line.push(t)},cr:function(){this.script=this.script+this.line.join("; "),this.line=new Array,this.script=this.script+"\n"},close:function(){if(this.line.length>0){for(var t=0;t<this.post_cmd.length;t++)this.push(pre_cmd[t]);this.script=this.script+this.line.join("; "),line=null}}},EJS.Compiler=function(t,e){this.pre_cmd=["var ___ViewO = [];"],this.post_cmd=new Array,this.source=" ",null!=t&&("string"==typeof t?(t=t.replace(/\r\n/g,"\n"),t=t.replace(/\r/g,"\n"),this.source=t):t.innerHTML&&(this.source=t.innerHTML),"string"!=typeof this.source&&(this.source="")),e=e||"<";var n=">";switch(e){case"[":n="]";break;case"<":break;default:throw e+" is not a supported deliminator"}this.scanner=new EJS.Scanner(this.source,e,n),this.out=""},EJS.Compiler.prototype={compile:function(options,name){options=options||{},this.out="";var put_cmd="___ViewO.push(",insert_cmd=put_cmd,buff=new EJS.Buffer(this.pre_cmd,this.post_cmd),content="",clean=function(t){return t=t.replace(/\\/g,"\\\\"),t=t.replace(/\n/g,"\\n"),t=t.replace(/"/g,'\\"')};this.scanner.scan(function(t,e){if(null==e.stag)switch(t){case"\n":content+="\n",buff.push(put_cmd+'"'+clean(content)+'");'),buff.cr(),content="";break;case e.left_delimiter:case e.left_equal:case e.left_comment:e.stag=t,content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),content="";break;case e.double_left:content+=e.left_delimiter;break;default:content+=t}else switch(t){case e.right_delimiter:switch(e.stag){case e.left_delimiter:"\n"==content[content.length-1]?(content=chop(content),buff.push(content),buff.cr()):buff.push(content);break;case e.left_equal:buff.push(insert_cmd+"(EJS.Scanner.to_text("+content+")))")}e.stag=null,content="";break;case e.double_right:content+=e.right_delimiter;break;default:content+=t}}),content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),buff.close(),this.out=buff.script+";";var to_be_evaled="/*"+name+"*/this.process = function(_CONTEXT,_VIEW) { try { with(_VIEW) { with (_CONTEXT) {"+this.out+" return ___ViewO.join('');}}}catch(e){e.lineNumber=null;throw e;}};";try{eval(to_be_evaled)}catch(e){if("undefined"==typeof JSLINT)throw e;JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var error=JSLINT.errors[i];if("Unnecessary semicolon."!=error.reason){error.line++;var e=new Error;throw e.lineNumber=error.line,e.message=error.reason,options.view&&(e.fileName=options.view),e}}}}},EJS.config=function(t){EJS.cache=null!=t.cache?t.cache:EJS.cache,EJS.type=null!=t.type?t.type:EJS.type,EJS.ext=null!=t.ext?t.ext:EJS.ext;var e=EJS.templates_directory||{};EJS.templates_directory=e,EJS.get=function(t,n){return 0==n?null:e[t]?e[t]:null},EJS.update=function(t,n){null!=t&&(e[t]=n)},EJS.INVALID_PATH=-1},EJS.config({cache:!0,type:"<",ext:".ejs"}),EJS.Helpers=function(t,e){this._data=t,this._extras=e,extend(this,e)},EJS.Helpers.prototype={view:function(t,e,n){return n||(n=this._extras),e||(e=this._data),new EJS(t).render(e,n)},to_text:function(t,e){return null==t||void 0===t?e||"":t instanceof Date?t.toDateString():t.toString?t.toString().replace(/\n/g,"<br />").replace(/''/g,"'"):""}},EJS.newRequest=function(){for(var t=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],e=0;e<t.length;e++)try{var n=t[e]();if(null!=n)return n}catch(i){continue}},EJS.request=function(t){var e=new EJS.newRequest;e.open("GET",t,!1);try{e.send(null)}catch(n){return null}return 404==e.status||2==e.status||0==e.status&&""==e.responseText?null:e.responseText},EJS.ajax_request=function(t){t.method=t.method?t.method:"GET";var e=new EJS.newRequest;e.onreadystatechange=function(){4==e.readyState&&t.onComplete(200==e.status?e:e)},e.open(t.method,t.url),e.send(null)
}}(),EJS.Helpers.prototype.date_tag=function(t,e,n){e instanceof Date||(e=new Date);for(var i=["January","February","March","April","May","June","July","August","September","October","November","December"],r=[],s=[],a=[],o=e.getFullYear(),c=e.getMonth(),h=e.getDate(),l=o-15;o+15>l;l++)r.push({value:l,text:l});for(var u=0;12>u;u++)s.push({value:u,text:i[u]});for(var f=0;31>f;f++)a.push({value:f+1,text:f+1});var p=this.select_tag(t+"[year]",o,r,{id:t+"[year]"}),d=this.select_tag(t+"[month]",c,s,{id:t+"[month]"}),m=this.select_tag(t+"[day]",h,a,{id:t+"[day]"});return p+d+m},EJS.Helpers.prototype.form_tag=function(t,e){return e=e||{},e.action=t,1==e.multipart&&(e.method="post",e.enctype="multipart/form-data"),this.start_tag_for("form",e)},EJS.Helpers.prototype.form_tag_end=function(){return this.tag_end("form")},EJS.Helpers.prototype.hidden_field_tag=function(t,e,n){return this.input_field_tag(t,e,"hidden",n)},EJS.Helpers.prototype.input_field_tag=function(t,e,n,i){return i=i||{},i.id=i.id||t,i.value=e||"",i.type=n||"text",i.name=t,this.single_tag_for("input",i)},EJS.Helpers.prototype.is_current_page=function(t){return window.location.href==t||window.location.pathname==t?!0:!1},EJS.Helpers.prototype.link_to=function(t,e,n){if(!t)var t="null";if(!n)var n={};return n.confirm&&(n.onclick=' var ret_confirm = confirm("'+n.confirm+'"); if(!ret_confirm){ return false;} ',n.confirm=null),n.href=e,this.start_tag_for("a",n)+t+this.tag_end("a")},EJS.Helpers.prototype.submit_link_to=function(t,e,n){if(!t)var t="null";if(!n)var n={};return n.onclick=n.onclick||"",n.confirm&&(n.onclick=' var ret_confirm = confirm("'+n.confirm+'"); if(!ret_confirm){ return false;} ',n.confirm=null),n.value=t,n.type="submit",n.onclick=n.onclick+(e?this.url_for(e):"")+"return false;",this.start_tag_for("input",n)},EJS.Helpers.prototype.link_to_if=function(t,e,n,i,r,s){return this.link_to_unless(0==t,e,n,i,r,s)},EJS.Helpers.prototype.link_to_unless=function(t,e,n,i,r){return i=i||{},t?r&&"function"==typeof r?r(e,n,i,r):e:this.link_to(e,n,i)},EJS.Helpers.prototype.link_to_unless_current=function(t,e,n,i){return n=n||{},this.link_to_unless(this.is_current_page(e),t,e,n,i)},EJS.Helpers.prototype.password_field_tag=function(t,e,n){return this.input_field_tag(t,e,"password",n)},EJS.Helpers.prototype.select_tag=function(t,e,n,i){i=i||{},i.id=i.id||t,i.value=e,i.name=t;var r="";r+=this.start_tag_for("select",i);for(var s=0;s<n.length;s++){var a=n[s],o={value:a.value};a.value==e&&(o.selected="selected"),r+=this.start_tag_for("option",o)+a.text+this.tag_end("option")}return r+=this.tag_end("select")},EJS.Helpers.prototype.single_tag_for=function(t,e){return this.tag(t,e,"/>")},EJS.Helpers.prototype.start_tag_for=function(t,e){return this.tag(t,e)},EJS.Helpers.prototype.submit_tag=function(t,e){return e=e||{},e.type=e.type||"submit",e.value=t||"Submit",this.single_tag_for("input",e)},EJS.Helpers.prototype.tag=function(t,e,n){if(!n)var n=">";var i=" ";for(var r in e){if(null!=e[r])var s=e[r].toString();else var s="";"Class"==r&&(r="class"),i+=-1!=s.indexOf("'")?r+'="'+s+'" ':r+"='"+s+"' "}return"<"+t+i+n},EJS.Helpers.prototype.tag_end=function(t){return"</"+t+">"},EJS.Helpers.prototype.text_area_tag=function(t,e,n){return n=n||{},n.id=n.id||t,n.name=n.name||t,e=e||"",n.size&&(n.cols=n.size.split("x")[0],n.rows=n.size.split("x")[1],delete n.size),n.cols=n.cols||50,n.rows=n.rows||4,this.start_tag_for("textarea",n)+e+this.tag_end("textarea")},EJS.Helpers.prototype.text_tag=EJS.Helpers.prototype.text_area_tag,EJS.Helpers.prototype.text_field_tag=function(t,e,n){return this.input_field_tag(t,e,"text",n)},EJS.Helpers.prototype.url_for=function(t){return'window.location="'+t+'";'},EJS.Helpers.prototype.img_tag=function(t,e,n){return n=n||{},n.src=t,n.alt=e,this.single_tag_for("img",n)},User.prototype={init:function(){this.user={}},get:function(t){return this.user[t]||!1},set:function(t,e){this.user[t]=e}},Cryptography.prototype={encrypt:function(t){return sjcl.encrypt(chat.user.get("passphrase"),t)},decrypt:function(t){return sjcl.decrypt(chat.user.get("passphrase"),t)}},Chat.prototype={init:function(t){var e=this;this.connection=new WebSocket("ws://127.0.0.1:2428","echo-protocol"),this.loggedin=!1,this.connection.onopen=t,this.connection.onclose=function(t){e.loggedin=!1,e.disconnectCallback(),setTimeout(function(){e.init(function(){e.login(),e.listen()})},5e3)}},isLoggedin:function(){return this.loggedin},push:function(t){chat.chat.connection.send(JSON.stringify(t))},listen:function(t){var e=this;"function"==typeof t&&(e.listenCallback=t),this.connection.addEventListener("message",function(t){try{if(message=JSON.parse(t.data),"undefined"!=typeof message.user&&(message.user.name=chat.cryptography.decrypt(message.user.name),message.user.email=chat.cryptography.decrypt(message.user.email)),"undefined"!=typeof message.users)for(var n in message.users)message.users[n].name=chat.cryptography.decrypt(message.users[n].name),message.users[n].email=chat.cryptography.decrypt(message.users[n].email);"undefined"!=typeof message.text&&(message.text=chat.cryptography.decrypt(message.text)),e.listenCallback(message)}catch(i){}})},login:function(t,e){chat.user.get("name")&&chat.user.get("email")&&(this.push({action:"login",name:chat.user.get("name"),email:chat.user.get("email")}),this.loggedin=!0)},send:function(t){this.push({action:"send",message:chat.cryptography.encrypt(t)})},setDisconnectCallback:function(t){this.disconnectCallback=t}},Page.prototype={init:function(){this.active=!0;var t,e;"undefined"!=typeof document.hidden?(t="hidden",e="visibilitychange"):"undefined"!=typeof document.mozHidden?(t="mozHidden",e="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(t="msHidden",e="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(t="webkitHidden",e="webkitvisibilitychange");var n=this;document.addEventListener(e,function(){n.active=!document[t],"function"==typeof n.visibilityChangeCallback&&n.visibilityChangeCallback()},!1)},isActive:function(){return this.active},setVisibilityChangeCallback:function(t){this.visibilityChangeCallback=t}},Template.prototype={init:function(t){this.templatePath=t},addEvent:function(t,e,n){this.events.push({selector:t,event:e,handler:n})},build:function(t,e,n){var i=this;this.events=[],"object"!=typeof e&&(e={}),"object"!=typeof n&&(n={}),e.template=this,e.actions=n;for(var r=$(new EJS({url:this.templatePath+t}).render(e)),s=0;s<this.events.length;s++){var a=this.events[s];r.delegate(a.selector,a.event,a.handler)}return r}},Route.prototype={init:function(){var t=this;$(window).bind("hashchange",function(){t.run()}),this.run()},clearHash:function(){window.location.hash="","function"==typeof window.history.replaceState&&window.history.replaceState({},"",window.location.href.slice(0,-1))},getHash:function(){return window.location.hash.substring(3)},setHash:function(t){history.pushState({},"Chat","#!/"+t),this.run()},goBack:function(){history.back()},run:function(){var t=this;return this.getHash().match("^chat/(.*)$")?(chat.user.set("passphrase",this.getHash().match("^chat/(.*)$")[1]),chat.chat.isLoggedin()?void showChat():void showHomepage()):(this.clearHash(),void showHomepage())}},Zepto(function(t){window.chat={user:new User,cryptography:new Cryptography,chat:new Chat,page:new Page,template:new Template,route:new Route},window.chat.user.init(),window.chat.chat.init(function(){window.chat.page.init(),window.chat.template.init("/assets/templates/"),window.chat.route.init()})});